
<!DOCTYPE html>

<html>
<head>
        <title>CMI Web GUI</title>

<!-- import all related js and css files -->

<script type="text/javascript" src="js/cmiwebgui-common.js"></script>
<script type="text/javascript" src="js/cmiwebgui-functions.js"></script>
<script type="text/javascript" src="js/cmiwebgui-constants.js"></script>

<script type="text/javascript" src="js/footable.js"></script>
<script type="text/javascript" src="js/footable.min.js"></script>

<link rel="stylesheet" type="text/css" href="css/cmiwebgui-common.css" />
<link rel="stylesheet" type="text/css" href="css/footable.bootstrap.css" />
<link rel="stylesheet" type="text/css" href="css/footable.bootstrap.min.css" />
<style type="text/css">
.error{
  color:red;
  font-size: 10px;
}
</style>
<nav class="navbar navbar-default" id="navigatebar">
</nav>
<script type="text/javascript">genNavigateBar();</script>

</head>
<body>

<div class="container">
<!-- Content Here -->
<br/>
<br/>
<br/>
<br/>

<form class="form-horizontal" id = "onboardCPECustomerSiteForm">
<fieldset>

<!-- Form Name -->
<legend>Onboard CPE to Customer Site</legend>
<div id="validationlerrordiv">
<h4 style="font-size: 12px; color : red" id="validationerrorlabel"></h4>
</div>

    <ul id="cpeTab" class="nav nav-tabs">
        <li class="active">
            <a href="#cpebase" data-toggle="tab">CPE</a>
        </li>
        <li><a href="#cpedomaincontroller" data-toggle="tab">Domain Controller</a></li>
        <li><a href="#cpedevice" data-toggle="tab">Device Details</a></li>
        <li><a href="#cpenetwork" data-toggle="tab">Networks Details</a></li>
    </ul>


<!-- Line End -->
<!-- Text input-->
    <div id="cpeTabContent" class="tab-content">
        <br>
        <!-- Start the cpe base tab -->

        <div class="tab-pane fade in active" id="cpebase">
            <!-- Select listbox for Existing Customers -->
            <div class="form-group">
              <label class="col-md-4 control-label" for="customerlist">Customer</label>  
              <div class="col-md-4">
                    <select id="customerlist" name="customerlist" class="form-control">
                    <option value="" disabled selected="selected" style="display: none"></option>
                    </select>    
              </div>
            </div>

            <!-- Select listbox for Existing Customer Sites, refreshed by change of selected customer -->
            <div class="form-group">
              <label class="col-md-4 control-label" for="customersitelist">Customer Site</label>  
              <div class="col-md-4">
                    <select id="customersitelist" name="customersitelist" class="form-control">
                    </select>    
              </div>
            </div>

            <div class="form-group">
              <label class="col-md-4 control-label" for="cpe-name">CPE Name</label>
              <div class="col-md-4">
              <input id="cpe-name" name="cpe-name" type="text" placeholder="CPE Name" class="form-control input-md" required>
            </div>
        </div>

        <!-- Text input-->
        <div class="form-group">
          <label class="col-md-4 control-label" for="cmi-pop-location">CMI PoP Location</label>
          <div class="col-md-4">
            <input id="cmi-pop-location" name="cmi-pop-location" type="text" placeholder="CMI PoP Location" class="form-control input-md" value="lonsdale">
          </div>
        </div>
        </div>
        <!-- End of the cpe base tab -->

        <!-- Begin of CPE Domain Controller -->
        <div class="tab-pane fade " id="cpedomaincontroller">
            <!-- Text input-->
            <div style="position: relative;left: 50px"><p style="color: gray; font-weight: bold;font-size: 20px"> CPE Domain Controller Details:</p>
                <button type="button" hidden="true" name="retrive" onclick="retrieveCPEBaseXML();">RetrieveCpeBaseXML</button>
            </div>
            <div class="form-group">
                <label class="col-md-4 control-label" for="domain-controller">Domain Controller</label>
                <div class="col-md-4">
                    <input id="domain-controller" name="domain-controller" type="text" placeholder="Domain Controller" class="form-control input-md" value="juniper-cso">
                </div>
            </div>

            <div class="form-group">
                <label class="col-md-4 control-label" for="cpe-as-number">CPE As Number</label>
                <div class="col-md-4">
                    <input id="cpe-as-number" name="cpe-as-number" type="text" placeholder="Cpe as Number" class="form-control input-md">
                </div>
            </div>

            <div class="form-group">
                <label class="col-md-4 control-label" for="pe-as-number">PE As Number</label>
                <div class="col-md-4">
                    <input id="pe-as-number" name="pe-as-number" type="text" placeholder="PE as Number" class="form-control input-md">
                </div>
            </div>

            <div class="form-group">
                <label class="col-md-4 control-label" for="pe-router-name">PE Router Name</label>
                <div class="col-md-4">
                    <input id="pe-router-name" name="pe-router-name" type="text" placeholder="PE Router Name" class="form-control input-md">
                </div>
            </div>

            <div class="form-group">
                <label class="col-md-4 control-label" for="deployment-template-name">Deployment Template Name</label>
                <div class="col-md-4">
                    <input id="deployment-template-name" name="deployment-template-name" type="text" placeholder="Deployment Template Name" class="form-control input-md" value="NFX_Telstra_uCPE">
                </div>
            </div>

            <!-- Select Basic --><!-- this field should belong to CPE Domain Controller -->
            <div class="form-group">
                <label class="col-md-4 control-label" for="customer-type">Customer Type</label>
                <div class="col-md-4">
                    <select id="customer-type" name="customer-type" class="form-control">
                        <option value="large">large</option>
                        <option value="medium">medium</option>
                        <option value="small" selected="selected">small</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-md-4 control-label" for="customer-username">Customer Username</label>
                <div class="col-md-4">
                    <input id="customer-username" name="customer-username" type="text" placeholder="Customer Username" class="form-control input-md">
                </div>
            </div>

            <div class="form-group">
                <label class="col-md-4 control-label" for="customer-password">Customer Password</label>
                <div class="col-md-4">
                    <input id="customer-password" name="customer-password" type="text" placeholder="Customer Password" class="form-control input-md">
                </div>
            </div>

        </div>

        <!-- End of CPE Domain Controller -->
        <!-- Start of Device Details tab -->
        <div class="tab-pane fade " id="cpedevice">
        <div style="position: relative;left: 50px"><p style="color: gray; font-weight: bold;font-size: 20px"> Device Details:</p>
            <button type="button" data-toggle="modal" data-target="#deviceModal">
                <b>Add a Device</b>
            </button>
            <button type="button" hidden="true" name="retrive" onclick="retrieveAllDevices();">RetrieveXML</button>
        </div>
            <!-- Add -->
            <br>
            <table class="table table-hover table-bordered" id="deviceTable">
                <thead>
                <tr title="Double click a row to update">
                    <th>Device Name</th>
                    <th>Device Type</th>
                    <th>Nat Required</th>
                    <th>Monitor Required</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <!-- Start of the Device Input form -->
        <!-- 模态框（Modal） -->
        <div class="modal fade" id="deviceModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="deviceModalLabel">
                            Device Detail:
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="col-md-4 control-label" for="device-name">Device Name</label>
                            <div class="col-md-4">
                                <input id="device-name" name="device-name" type="text" placeholder="Device Name" class="form-control input-md">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-md-4 control-label" for="device-type">Device Type</label>
                            <div class="col-md-4">
                                <select id="device-type" name="device-type" class="form-control">
                                    <option value="Server" selected="true">Server</option>
                                    <option value="vSRX">vSRX</option>
                                    <option value="Switch">Switch</option>
                                    <option value="Modem">Modem</option>
                                </select>
                            </div>
                        </div>
                        <!-- Select Basic -->
                        <div class="form-group">
                            <label class="col-md-4 control-label" for="nat-required">Nat Required</label>
                            <div class="col-md-4">
                                <select id="nat-required" name="nat-required" class="form-control">
                                    <option value="True" >True</option>
                                    <option value="False" selected="selected">False</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-4 control-label" for="monitoring-required">Monitoring Required</label>
                            <div class="col-md-4">
                                <select id="monitoring-required" name="monitoring-required" class="form-control">
                                    <option value="True" selected="selected">True</option>
                                    <option value="False">False</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" id="closedevicebtn" data-dismiss="modal">Close
                        </button>
                        <button type="button" class="btn btn-primary" id="createdevicebtn" onclick="addDevice();">
                            Create
                        </button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>

        <!-- End of the Device input form -->
        <!-- End of the Device Details tab -->

        <!-- Start of Network Details tab -->
        <div class="tab-pane fade " id="cpenetwork">
            <div style="position: relative;left: 50px"><p style="color: gray; font-weight: bold;font-size: 20px"> Network Details:</p>
            <button type="button" data-toggle="modal" data-target="#networkModal">
                <b>Add a Network</b>
            </button>
            <button type="button" hidden="true" name="retrive" onclick="retrieveAllNetworks();">RetrieveXML</button>
            </div>
            <div>
            <br>
            <table class="table table-hover table-bordered" id="networkTable">
                <thead>
                <tr>
                    <th>Network Name</th>
                    <th>Subset Type</th>
                    <th>Size</th>
                    <th>Pre-Configured</th>
                    <th>SubNet</th>
                    <th>Gateway Ip</th>
                    <th>Local Ip</th>
                    <th>Local-Interface</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            </div>
        </div>
        <!-- End of Network Details tab -->
        <!-- Start of the network Input form -->
        <div class="modal fade" id="networkModal" tabindex="-2" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="networkModalLabel">
                            Network Detail:
                        </h4>
                        <div><h4 style="font-size: 12px; color: red" id="validatenetworkerrorlabel"></h4></div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="col-md-4 control-label" for="network-name">Network Name</label>
                            <div class="col-md-4">
                                <select id="network-name" name="network-name" class="form-control">
                                    <option value="nfx-oam" selected="selected">nfx-oam</option>
                                    <option value="nfx-wan0">nfx-wan0</option>
                                    <option value="nfx-wan1">nfx-wan1</option>
                                    <option value="nfx-lan">nfx-lan</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-md-4 control-label" for="subnet-type">Subnet Type</label>
                            <div class="col-md-4">
                                <select id="subnet-type" name="subnet-type" class="form-control">
                                    <option value="CPEMGMT" selected="selected">CPEMGMT</option>
                                    <option value="CPEWAN">CPEWAN</option>
                                    <option value="CPELAN">CPELAN</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-4 control-label" for="size">Size   </label>
                            <div class="col-md-4">
                                <input id="size" name="size" type="text" placeholder="Size" class="form-control input-md">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-4 control-label" for="pre-configured">Pre-Configured</label>
                            <div class="col-md-4">
                                <select id="pre-configured" name="pre-configured" class="form-control">
                                    <option value="True" >True</option>
                                    <option value="False" selected="selected">False</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-4 control-label" for="subnet">Subnet</label>
                            <div class="col-md-4">
                                <input id="subnet" name="subnet" type="text" placeholder="subnet" class="form-control input-md"  data-toggle="tooltip" title="e.g. 10.80.18.0/28">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-4 control-label" for="gateway-ip">Gateway IP</label>
                            <div class="col-md-4">
                                <input id="gateway-ip" name="gateway-ip" type="text" placeholder="gatewayIP" class="form-control input-md" data-toggle="tooltip" title="IPv4 address">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-4 control-label" for="local-ip">Local IP</label>
                            <div class="col-md-4">
                                <input id="local-ip" name="local-ip" type="text" placeholder="localip" class="form-control input-md" data-toggle="tooltip" title="IPv4 address">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-md-4 control-label" for="local-interface">Local-Interface</label>
                            <div class="col-md-4">
                                <select id="local-interface" name="local-interface" class="form-control">
                                    <option value=""  selected="selected"></option>
                                    <option value="WAN_0">WAN_0</option>
                                    <option value="WAN_1">WAN_1</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" id="closenetworkbtn" data-dismiss="modal">Close
                        </button>
                        <button type="button" class="btn btn-primary" id="createnetworkbtn" onclick="addNetwork();">
                            Create
                        </button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
    <!-- End of the network input modal -->        
    </div>

<br/>
<br/>



<div align="center">
<!-- Trigger the modal with a button -->
<button type="button" class="btn btn-success btn-lg" id ="triggerValidate" >Submit</button>
<button type="button" hidden="true" id ="onboardCPEtoCustomerSite" data-toggle="modal" data-target="#myModal">realSubmit</button>
</div>
<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Is this correct?</h4>
      </div>
      <div class="modal-body">
        <h4 id="targetcustomersitetext"></h4>
        <textarea id = "xmltext" style="width: 100%; height: 200px; ">Placeholder Text for Symphony Project X-Mas.</textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-success" id = "goAheadButton">Yes, go ahead!</button>
      </div>
    </div>

  </div>
</div>

</fieldset>
</form>

<script type="text/javascript">

//When pre-configured is false, clear the input of subnet, gateway ip, local ip
$('#pre-configured').on("change",function(){

    if($(this).val() == "False") {
        $('#subnet').val("");
        $('#gateway-ip').val("");
        $('#local-ip').val("");
    }
});

$('#triggerValidate').on('click',function(event)
  {

    if ( ! validateCPEForm())
        return;

    $('#validationerrorlabel').text("");
    //If validate correct, then trigger the click of realSubmit
    $('#onboardCPEtoCustomerSite').click();
    
});

//return true if sucess, otherwise, false
function validateCPEForm(){

    if($('#cpe-name').val().length<=0) {
        $('#validationerrorlabel').text("Please input CPE Name.");
        $('#cpe-name').focus();
        return false;
    }
    if( $('#customerlist').val() ==null || $('#customerlist').val().length<=0) {
        $('#validationerrorlabel').text("Please select a Customer.");
        $('#customerlist').focus();
        return false;
    }
    if($('#customersitelist').val() ==null || $('#customersitelist').val().length<=0) {
        $('#validationerrorlabel').text("Please select a Customer Site.");
        $('#customersitelist').focus();
        return false;
    }

    if($('#domain-controller').val().length<=0) {
        $('#validationerrorlabel').text("Please input Domain Controller Name.");
        $('#domain-controller').focus();
        return false;
    }

    if($('#cpe-as-number').val().length<=0) {
        $('#validationerrorlabel').text("Please input CPE as Number.");
        $('#cpe-as-number').focus();
        return false;
    }

    if($('#pe-as-number').val().length<=0) {
        $('#validationerrorlabel').text("Please input PE as Number.");
        $('#pe-as-number').focus();
        return false;
    }

    if($('#pe-router-name').val().length<=0) {
        $('#validationerrorlabel').text("Please input PE Router Name.");
        $('#pe-router-name').focus();
        return false;
    }

    if($('#deployment-template-name').val().length<=0) {
        $('#validationerrorlabel').text("Please input Deployment Template Name.");
        $('#deployment-template-name').focus();
        return false;
    }

    if($('#customer-username').val().length<=0) {
        $('#validationerrorlabel').text("Please input Customer Username.");
        $('#customer-username').focus();
        return false;
    }

    if($('#customer-password').val().length<=0) {
        $('#validationerrorlabel').text("Please input Customer Password.");
        $('#customer-password').focus();
        return false;
    }

    //check if all 4 network inputted
    var allNetworkNames = retrieveAllNetworkNames();

    if( allNetworkNames.indexOf('nfx-oam') < 0) {
        $('#validationerrorlabel').text("Lack of network nfx-oam!");
        return false;
    }
    if( allNetworkNames.indexOf('nfx-wan0') < 0) {
        $('#validationerrorlabel').text("Lack of network nfx-wan0!");
        return false;
    }
    if( allNetworkNames.indexOf('nfx-wan1') < 0) {
        $('#validationerrorlabel').text("Lack of network nfx-wan1!");
        return false;
    }
    if( allNetworkNames.indexOf('nfx-lan') < 0) {
        $('#validationerrorlabel').text("Lack of network nfx-lan!");
        return false;
    }


    return true;
}

//Retrieve the existing customers on CPE, fill the select customer listbox
$().ready( function(){

    $.post("/php/get_customer_cpe.php").done(function(data){
      //alert(data);
      //Then analyse the xml, fill the customer listbox
      var xmlDoc = $.parseXML(data);
      $(xmlDoc).find("customer").each( function () {
      
          var custname = $('customer-name',this).text();
          var cidn=$('cidn',this).text();
          var optionStr = '<option value="'+cidn+'">'+custname+'</option>';
          
          $('#customerlist').append(optionStr);
          });
      });

    //$('#customerlist option:first').trigger('change');
    //alert($('#customerlist').find('option:selected').value());
});


//When selected customer change in customer listbox, then change customer sites correcpondingly
$('#customerlist').change(function(){
    
    var customerCidn = $(this).val();
    var customerName = $(this).find('option:selected').text();
    //alert(customerName + ":"+customerCidn);
    //Empty the cusotmer site listbox
    $('#customersitelist').empty();
    $.post("/php/get_customer_site_cpe.php",{ cidn: customerCidn }).done(function(data){
      //alert(data);
      //Then analyse the xml, build the site table
      var xmlDoc = $.parseXML(data);
      $(xmlDoc).find("customer-site").each( function () {
      
          var siteName = $('site-name',this).text();
          var siteId=$('site-id',this).text();

          var optionStr = '<option value="'+siteId+'">'+siteName+'</option>';
          
          $('#customersitelist').append(optionStr);
          });

      });

});

//initiate the tooltip
$().ready(function () { $("[data-toggle='tooltip']").tooltip(); 

  for( var key in onboardCPECustomerSiteTips) {
      //alert(key+":"+onboardCPECustomerSiteTips[key]);
      //alert($(key).attr('id'));
      $('#'+key).attr('title',onboardCPECustomerSiteTips[key]);
  }

});

var selectedDevice = { deviceName: "", deviceType: "Server", natRequired: "False", monitoringRequired: "True"};
var selectedNetwork = { networkName: "nfx-oam", subnetType: "CPEMGMT", size: "",preConfigured: "False", subnet: "", gatewayIP: "", 
                        localIP: "", localInterface: ""};

function setSelectedDeviceDefaultValue() {
    selectedDevice.deviceName = "";
    selectedDevice.deviceType = "Server";
    selectedDevice.natRequired = "False";
    selectedDevice.monitoringRequired = "True";
}

function setSelectedNetworkDefaultValue() {
    selectedNetwork.networkName = "nfx-oam";
    selectedNetwork.subnetType = "CPEMGMT";
    selectedNetwork.size = "";
    selectedNetwork.preConfigured = "False";
    selectedNetwork.subnet = "";
    selectedNetwork.gatewayIP = "";
    selectedNetwork.localIP = "";
    selectedNetwork.localInterface = "";

}

$('#cpe-name').focus();

//Set the focus when each tabpage shown
$('a[data-toggle="tab"').on('shown.bs.tab',function(e){
    var activeTab = $(e.target).text();
    if (activeTab == "CPE")
        $('#cpe-name').focus();
    else if (activeTab == "Domain Controller")
        $('#domain-controller').focus();
    }

);

$('#onboardCPEtoCustomerSite').on('click', function(event) {

    console.log("Onboard CPE to Customer Site Submit Button Pressed");

    var onboardCPEToCustomerSitePayload = 
    `<?xml version="1.0"?>
     <cpe> 
       `+ retrieveCPEBaseXML()+
          retrieveAllDevices()+
          retrieveAllNetworks()+
       `
       <add-device-to-sciencelogic/>
  </cpe>`;

    console.log(onboardCPEToCustomerSitePayload);
    
    //Set the target customer site text
    var customerCidn = $('#customerlist').val();
    var customerName = $('#customerlist').find('option:selected').text();
    var siteId = $('#customersitelist').val();
    var siteName = $('#customersitelist').find('option:selected').text();
    var targetTxt = "Onboard to "+customerName+"("+customerCidn+") on "+siteName+"("+siteId+")";

    $('#targetcustomersitetext').text(targetTxt);
    document.getElementById("xmltext").value = onboardCPEToCustomerSitePayload;

});



$('#goAheadButton').on('click', function(event) {


    console.log("finalbuttonPressed");
    var finalPayload = document.getElementById("xmltext").value

    console.log("FINAL PAYLOAD IS");
    console.log(finalPayload);

    var customerCidn = $('#customerlist').val();
    var siteId = $('#customersitelist').val();
    //alert(customerCidn+" "+siteId);
    $.post("/php/onboard_cpe_customer_site.php",{ customer_cidn: customerCidn, site_id: siteId, cpe_xml: finalPayload })
      .done(function( data ) {
            refreshStatusDivBasedonPostResult(data, "Onboard CPE to Customer Site");
      });

    document.getElementById('infoDiv').style.display = "block";
    document.getElementById('onboardCPECustomerSiteForm').style.display = "none";
    $('#myModal').modal('hide');

});

//Clear the input in Device Modal when hide it
$(function(){
    //Clear the inputted Device details when hide;
    $('#deviceModal').on('hide.bs.modal',
            function(){
                setSelectedDeviceDefaultValue();
            });
    //Fill the Device Detail when open if there is an existing device selected
    $('#deviceModal').on('show.bs.modal',
            function(){
                //alert('Fill the device detail!');
                $('#device-name').val(selectedDevice.deviceName);
                $("#device-type").val(selectedDevice.deviceType);
                $("#nat-required").val(selectedDevice.natRequired);
                $("#monitoring-required").val(selectedDevice.monitoringRequired);
                //If deviceName is not empty, then it's Update, set the button to "Update"
                if(selectedDevice.deviceName.length >0) {
                    $('#createdevicebtn').text("Update");
                    $('#closedevicebtn').hide();
                }
                else {
                    $('#closedevicebtn').show();
                    $('#createdevicebtn').text("Create");
                }
                //Set the focus on device name input
                $('#device-name').focus();
            });
    //Clear the inputted Network details when hide networkModal
    $('#networkModal').on('hide.bs.modal',
            function(){
                
                setSelectedNetworkDefaultValue();
            });

    //Fill the Network Detail when open if there is an existing network selected
    $('#networkModal').on('shown.bs.modal',
        function(){
            $('#network-name').val(selectedNetwork.networkName);
            $('#subnet-type').val(selectedNetwork.subnetType);
            $('#size').val(selectedNetwork.size);
            $('#pre-configured').val(selectedNetwork.preConfigured);
            $('#subnet').val(selectedNetwork.subnet);
            $('#gateway-ip').val(selectedNetwork.gatewayIP);
            $('#local-ip').val(selectedNetwork.localIP);                
            $('#local-interface').val(selectedNetwork.localInterface);
            //If networkName is not empty, then it's Update, set the button to "Update"
            if(selectedNetwork.size.length >0){
                $('#createnetworkbtn').text("Update");
                $('#closenetworkbtn').hide();
            }
            else {
                $('#createnetworkbtn').text("Create");
                $('#closenetworkbtn').show();
            }

            //Set the focus on network name input
            $('#networkName').focus();

    });

});

function validateAlpha (value) {
    var regex = "^[0-9a-zA-Z-_]+$";
    regex = new RegExp(regex);
    return regex.test(value);
}


function addDevice() {


    selectedDevice.deviceName = $('#device-name').val();
    selectedDevice.deviceType = $('#device-type').val();
    selectedDevice.natRequired = $('#nat-required').val();
    selectedDevice.monitoringRequired = $('#monitoring-required').val();

    //Validate the device 
    if( selectedDevice.deviceName <=0 ){
        alert("Please input Device Name.")
        $('#device-name').focus();
        return;
    }
    //alert(validateAlpha(selectedDevice.deviceName));
    if (!validateAlpha(selectedDevice.deviceName)){
        alert("Device Name only accept alphanumeric, '-'/dash and '_'/underline.");
        $('#device-name').focus();
        return;
    }

    var trStr = "<tr><td>" + selectedDevice.deviceName +
            "</td><td>" +
            selectedDevice.deviceType +"</td><td>" + selectedDevice.natRequired +
            "</td><td>" + selectedDevice.monitoringRequired+"</td>" +
            "<td align='center'><button type='button' id='del_"+selectedDevice.deviceName +
            "'>Delete</button></td></tr>";


    var tmpDeviceName = selectedDevice.deviceName;

    $('#deviceModal').modal('hide');
    $('#deviceTable tbody').append(trStr);
    //add function to delete button click and tr double click
    $('#del_'+tmpDeviceName).click(function(){
        $(this).parent().parent().remove();
    });

    //This is useless, deviceModal hide will set to default
    setSelectedDeviceDefaultValue();

    $('#deviceTable tr').dblclick(
            function(){
                var row = $(this).closest("tr");

                selectedDevice.deviceName = row.find('td:eq(0)').text();
                selectedDevice.deviceType = row.find('td:eq(1)').text();
                selectedDevice.natRequired = row.find('td:eq(2)').text();
                selectedDevice.monitoringRequired = row.find('td:eq(3)').text();
                $(this).remove();
                $('#deviceModal').modal('show');

            }
    );
}

function retrieveAllDevices(){
    //alert("In retrieve");
    var deviceStr=`
    <device-details>`;
    $('#deviceTable').find('tr').each(
      function() {
          var tdAttr =  $(this).find("td");
          var deviceName = tdAttr.eq(0).text();
          var deviceType = tdAttr.eq(1).text();
          var netRequired = tdAttr.eq(2).text();
          var monitoringRequired = tdAttr.eq(3).text();
          if( deviceName != "" && deviceType !="") {
              deviceStr = deviceStr + `
              <device> 
                <device-name>` + deviceName + `</device-name>
                <device-type>` + deviceType + `</device-type>
                <nat-required>` + netRequired + `</nat-required>
                <monitoring-required>` + monitoringRequired + `</monitoring-required>
              </device>`;
          }
      }
    );
    deviceStr = deviceStr + `
    </device-details>`;
    //alert(deviceStr);
    return deviceStr;
}

function validateIPv4(value) {

 return /^(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)$/i.test(value);
}

function validateSubnet(value){
    return /^(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\/(25[0-5]|2[0-4]\d|[01]?\d\d?)$/i.test(value);
}

//Success, return true; otherwise false.
function validateNetworkForm(){
    if(selectedNetwork.size.trim().length <=0){
        $('#validatenetworkerrorlabel').text("Please input the size!");
        $('#size').focus();
        return false;
    }

    //network name vs subnet type
    if( selectedNetwork.networkName == 'nfx-oam' && selectedNetwork.subnetType != 'CPEMGMT'){
        $('#validatenetworkerrorlabel').text("Subnet Type must match with Network Name: \r\n"+
            "nfx-oam -> CPEMGMT, nfx-wan0/1 -> CPEWAN, nfx-lan -> CPELAN.");
        $('#subnet-type').focus();
        return false;
    }

    if( selectedNetwork.networkName == 'nfx-wan0' && selectedNetwork.subnetType != 'CPEWAN'){
        $('#validatenetworkerrorlabel').text("Subnet Type must match with Network Name: \r\n"+
            "nfx-oam -> CPEMGMT, nfx-wan0/1 -> CPEWAN, nfx-lan -> CPELAN.");
        $('#subnet-type').focus();
        return false;
    }

    if( selectedNetwork.networkName == 'nfx-wan1' && selectedNetwork.subnetType != 'CPEWAN'){
        $('#validatenetworkerrorlabel').text("Subnet Type must match with Network Name: \r\n"+
            "nfx-oam -> CPEMGMT, nfx-wan0/1 -> CPEWAN, nfx-lan -> CPELAN.");
        $('#subnet-type').focus();
        return false;
    }

    if( selectedNetwork.networkName == 'nfx-lan' && selectedNetwork.subnetType != 'CPELAN'){
        $('#validatenetworkerrorlabel').text("Subnet Type must match with Network Name: \r\n"+
            "nfx-oam -> CPEMGMT, nfx-wan0/1 -> CPEWAN, nfx-lan -> CPELAN.");
        $('#subnet-type').focus();
        return false;
    }

    //network name vs local interface 
    if( selectedNetwork.networkName == 'nfx-wan0' && selectedNetwork.localInterface != 'WAN_0'){
        $('#validatenetworkerrorlabel').text("Local Interface must be WAN_0 when select nfx-wan0");
        $('#local-interface').focus();
        return false;
    }
    if( selectedNetwork.networkName == 'nfx-wan1' && selectedNetwork.localInterface != 'WAN_1'){
        $('#validatenetworkerrorlabel').text("Local Interface must be WAN_1 when select nfx-wan1");
        $('#local-interface').focus();
        return false;
    }
    

    if ( selectedNetwork.preConfigured == 'True' && ( selectedNetwork.gatewayIP.length <= 0 || selectedNetwork.localIP.length <= 0 || selectedNetwork.subnet.length <=0)){
        $('#validatenetworkerrorlabel').text("Please set up the subnet, gatway ip and local ip if PreConfigured is True!");
        $('#subnet').focus();
        return false;
    }
    //validate the network
    if( selectedNetwork.gatewayIP.length > 0 && (! validateIPv4(selectedNetwork.gatewayIP))){
        $('#validatenetworkerrorlabel').text("Please input a valid IPv4 in Gateway IP.");
        $('#gateway-ip').focus();
        return false;
    }
    if( selectedNetwork.localIP.length > 0 && (! validateIPv4(selectedNetwork.localIP))){
        $('#validatenetworkerrorlabel').text("Please input a valid IPv4 in local IP.");
        $('#local-ip').focus();
        return false;
    }
    //validate the subnet
    if( selectedNetwork.subnet.length > 0 && (! validateSubnet(selectedNetwork.subnet))){
        $('#validatenetworkerrorlabel').text("Please input a valid IPv4 subnet address in Subnet.");
        $('#subnet').focus();
        return false;
    }

    return true;
}

function addNetwork() {

    selectedNetwork.networkName = $('#network-name').val();
    selectedNetwork.subnetType = $('#subnet-type').val();
    selectedNetwork.size = $('#size').val();
    selectedNetwork.preConfigured = $('#pre-configured').val();
    selectedNetwork.subnet = $('#subnet').val();
    selectedNetwork.gatewayIP = $('#gateway-ip').val();
    selectedNetwork.localIP = $('#local-ip').val();
    selectedNetwork.localInterface = $('#local-interface').val();


    if( !validateNetworkForm())
        return;

    $('#validatenetworkerrorlabel').text("");

    //If networkName is 
    var trStr = "<tr> <td>"+selectedNetwork.networkName+
            "</td><td>"+
            selectedNetwork.subnetType+"</td><td>"+selectedNetwork.size+
            "</td><td>"+selectedNetwork.preConfigured+"</td><td>"+
            selectedNetwork.subnet+"</td><td>"+
            selectedNetwork.gatewayIP+"</td><td>"+
            selectedNetwork.localIP + "</td><td>"+
            selectedNetwork.localInterface+"</td>"+
            "<td align='center'><button type='button' id='del_"+selectedNetwork.networkName+"'>Delete</button>"+"</td></tr>";

    //alert(trStr);
    var tmpNetworkName = selectedNetwork.networkName; 

    $('#networkModal').modal('hide');
    $('#networkTable tbody').append(trStr);

    //add function to delete button click and tr double click
    $('#del_'+tmpNetworkName).click(function(){
        $(this).parent().parent().remove();
    });

    setSelectedNetworkDefaultValue();

    $('#networkTable tr').dblclick(
            function(){
                var row = $(this).closest("tr");

                selectedNetwork.networkName = row.find('td:eq(0)').text();
                selectedNetwork.subnetType = row.find('td:eq(1)').text();
                selectedNetwork.size=row.find('td:eq(2)').text();
                selectedNetwork.preConfigured=row.find('td:eq(3)').text();
                selectedNetwork.subnet=row.find('td:eq(4)').text();
                selectedNetwork.gatewayIP=row.find('td:eq(5)').text();
                selectedNetwork.localIP=row.find('td:eq(6)').text();
                selectedNetwork.localInterface=row.find('td:eq(7)').text();

                $(this).remove();
                $('#networkModal').modal('show');

            }
    );

}

function retrieveAllNetworks(){
    //alert("In retrieve");
    var networkStr=`
    <networks>`;
    $('#networkTable').find('tr').each(
      function() {
          var tdAttr =  $(this).find("td");
          var networkName = tdAttr.eq(0).text();
          var subnetType = tdAttr.eq(1).text();
          var size = tdAttr.eq(2).text();
          var preConfigured=tdAttr.eq(3).text();
          var subnet = tdAttr.eq(4).text();
          var gatewayIP = tdAttr.eq(5).text();
          var localIP=tdAttr.eq(6).text();
          var localInterface=tdAttr.eq(7).text();

          if( networkName != "" && subnetType !="") {
              networkStr += `
              <network>
                 <network-name>`+networkName+`</network-name>
                 <subnet-type>`+subnetType+`</subnet-type>
                 <size>`+size+`</size>
                 <pre-configured>`+preConfigured+`</pre-configured>`;
              if (preConfigured == "True") {
                networkStr +=` 
                  <subnet>`+subnet+`</subnet>
                  <gateway-ip>`+gatewayIP+`</gateway-ip>
                  <local-ip>`+localIP+`</local-ip>`;
              }
              //Only when networkName is nfx-wan0/1, contains localInterface
              if( networkName == 'nfx-wan0' || networkName=='nfx-wan1')
                  networkStr += `
                      <local-interface>`+localInterface+`</local-interface>`;
              
              networkStr += `       
               </network>`;
          }
      }
    );
    networkStr+=`
    </networks>`;
    //alert(networkStr);
    return networkStr;
}

function retrieveAllNetworkNames(){
    //alert("In retrieve");
    var networkNameStr=""
    
    $('#networkTable').find('tr').each(
      function() {
        var tdAttr =  $(this).find("td");
        var networkName = tdAttr.eq(0).text();
        networkNameStr += networkName;
      }
    );
    return networkNameStr;
}

function retrieveCPEBaseXML() {
            var cpeName = document.getElementById('cpe-name').value;
            var cmiPopLocation = document.getElementById('cmi-pop-location').value;
            var domainController = document.getElementById('domain-controller').value;
            var cpeAsNumber = document.getElementById('cpe-as-number').value;
            var  peAsNumber= document.getElementById('pe-as-number').value;
            var  peRouterName= document.getElementById('pe-router-name').value;
            var  deploymentTemplateName= document.getElementById('deployment-template-name').value;
            var customerType = document.getElementById('customer-type').value;
            var  customerUsername= document.getElementById('customer-username').value;
            var  customerPassword= document.getElementById('customer-password').value;

            var cpeBaseStr = `<cpe-name>`+cpeName+`</cpe-name> 
              <cmi-pop-locations> 
                <cmi-pop-location>
                <cmi-pop-location>`+cmiPopLocation+`</cmi-pop-location>
                </cmi-pop-location>
              </cmi-pop-locations> 
              <cpe-domain-controller> 
                <domain-controller>`+domainController+`</domain-controller> 
                <cpe-as-number>`+cpeAsNumber+`</cpe-as-number> 
                <pe-as-number>`+peAsNumber+`</pe-as-number> 
                <pe-router-name>`+peRouterName+`</pe-router-name> 
                <deployment-template-name>`+deploymentTemplateName+`</deployment-template-name> 
                <customer-type>`+customerType+`</customer-type> 
                <customer-username>`+customerUsername+`</customer-username> 
                <customer-password>`+customerPassword+`</customer-password> 
              </cpe-domain-controller>`;

            //alert(cpeBaseStr);
            return cpeBaseStr;
}
</script>
<script type="text/javascript" src="js/cmiwebgui-validation.js"></script>
<script type="text/javascript">

var modelForm = $('#onboardCPECustomerSiteForm');

onboardCPECustomerSiteRules(modelForm);
  
</script>

<br/>
<br/>
<br/>


<div id="infoDiv"  style="display:none;" class="answer_list" > 

<div id = "statusResponseAlert" class="alert alert-info">
    <strong>Status</strong> Click this button to check the status of the query...
    <button type="button" class="btn btn-success" id = "monitorStatus" onclick="monitorStatusFunction()">Monitor Status</button>
    <button type="button" class="btn btn-success" id = "gettaskdetails" onclick="gettaskdetail();">Task Detail</button><br/>
    <button type="button" class="btn btn-primary" id ="closestatusdivbtn" onclick='closeStatusDivOnboard("onboardCPECustomerSiteForm");'>Go Back</button> 
 
     
    <div><br/></div>
    <div id="statustext" class="alert alert-info"></div>
    <input type="hidden" id="savetaskid" value="">
</div>


<div class="alert alert-danger">
  <strong>Note!</strong> Only proceed to Ship CPE after Step 4 has been succesfully completed. 
 
  <a href="/ship_cpe.html" class="btn btn-danger" role="button">Continue to Ship CPE</a>


</div>


</div>


</div>
</body>

</html>


